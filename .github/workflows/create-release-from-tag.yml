name: Create Release from Tag

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name to create release from'
        required: true
        default: 'latest'
      release_type:
        description: 'Type of release'
        required: true
        default: 'prerelease'
        type: choice
        options:
          - 'prerelease'
          - 'release'
          - 'draft'
      minecraft_version:
        description: 'Minecraft version for the release'
        required: true
        default: '1.21.5'
        type: choice
        options:
          - '1.21.4'
          - '1.21.5'

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Checkout specific tag
      if: github.event.inputs.tag_name != 'latest'
      run: |
        TAG_NAME="${{ github.event.inputs.tag_name }}"
        echo "Checking out tag: $TAG_NAME"
        git checkout "tags/$TAG_NAME" || git checkout "$TAG_NAME"

    - name: Build project
      run: |
        echo "Building cozisAddon for Minecraft ${{ github.event.inputs.minecraft_version }}"
        ./gradlew clean build --no-daemon --stacktrace
        echo "Build completed successfully"

    - name: List build artifacts
      run: |
        echo "Build artifacts:"
        ls -la build/libs/
        echo "JAR files found:"
        find build/libs/ -name "*.jar" -type f

    - name: Create release notes
      id: release_notes
      run: |
        MINECRAFT_VERSION="${{ github.event.inputs.minecraft_version }}"
        TAG_NAME="${{ github.event.inputs.tag_name }}"
        COMMIT_SHA="${{ github.sha }}"
        
        cat > release_notes.md << EOF
        ## ðŸš€ cozisAddon Release - Minecraft $MINECRAFT_VERSION
        
        ### ðŸ“¦ Release Information
        - **Minecraft Version**: $MINECRAFT_VERSION
        - **Tag**: $TAG_NAME
        - **Commit**: \`$COMMIT_SHA\`
        - **Release Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        ### ðŸ”§ Features
        - **PhasePlus Module**: Phase into blocks using ender pearls
        - **ElytraSwap Module**: Automatic elytra swapping with durability monitoring
        - **Movement Utilities**: Enhanced movement capabilities
        - **Hunting Tools**: Advanced hunting and tracking features
        - **Render Enhancements**: Improved visual features
        
        ### ðŸ“‹ Installation Instructions
        1. Download the appropriate JAR file for your Minecraft version
        2. Place the JAR file in your mods folder
        3. Ensure you have the required dependencies installed
        4. Launch Minecraft and enjoy!
        
        ### ðŸ› ï¸ Dependencies Required
        - **Fabric Loader**: 0.17.3+
        - **Fabric API**: 0.128.2+$MINECRAFT_VERSION
        - **Meteor Client**: $MINECRAFT_VERSION-SNAPSHOT
        - **Baritone**: $MINECRAFT_VERSION-SNAPSHOT (optional)
        
        ### ðŸ“ Files Included
        - \`cozisaddon-$MINECRAFT_VERSION.jar\` - Main release JAR
        - \`cozisaddon-$MINECRAFT_VERSION-dev.jar\` - Development JAR with debug info
        
        ### ðŸ¤– Automated Release
        This release was created from tag \`$TAG_NAME\` by GitHub Actions.
        
        **Workflow**: [Create Release from Tag](https://github.com/${{ github.repository }}/actions/workflows/create-release-from-tag.yml)
        EOF
        
        echo "Release notes created"

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.tag_name }}
        release_name: cozisAddon v${{ github.event.inputs.minecraft_version }} - ${{ github.event.inputs.tag_name }}
        body_path: release_notes.md
        draft: ${{ github.event.inputs.release_type == 'draft' }}
        prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}

    - name: Upload Main JAR
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: build/libs/cozisaddon-${{ github.event.inputs.minecraft_version }}.jar
        asset_name: cozisaddon-${{ github.event.inputs.minecraft_version }}.jar
        asset_content_type: application/java-archive

    - name: Upload Dev JAR
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: build/libs/cozisaddon-${{ github.event.inputs.minecraft_version }}-dev.jar
        asset_name: cozisaddon-${{ github.event.inputs.minecraft_version }}-dev.jar
        asset_content_type: application/java-archive

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cozisaddon-${{ github.event.inputs.minecraft_version }}-${{ github.event.inputs.tag_name }}
        path: build/libs/
        retention-days: 30

    - name: Notify success
      run: |
        echo "âœ… Successfully created release from tag ${{ github.event.inputs.tag_name }}"
        echo "ðŸ“¦ Release: ${{ steps.create_release.outputs.html_url }}"
        echo "ðŸ·ï¸ Tag: ${{ github.event.inputs.tag_name }}"
